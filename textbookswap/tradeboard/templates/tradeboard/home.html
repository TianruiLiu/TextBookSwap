{% extends 'tradeboard/base.html' %}
{% load static %}

{% block content %}

    <link rel="stylesheet" type="text/css" href="{% static 'tradeboard/tb_main.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <style>
        .instruction {
            height: 250px;
            width: 200px;
          background-color: white;
          color: #0066ff;
          margin: 20px;
          padding: 20px;
        } 
        </style>

    <div class = "panels">
        <div class = "left-panel">
            <div class = "profile-section">
                <img class= "profile-pic" src = "{{user.profile.image.url}}"/>
                <div class = "profile-info">
                    <h2 class = "fl-users-name">{{user.first_name}} {{user.last_name}}</h2>
                </div>
                <hr/>
            </div>
            <div class = "instruction">
                <h3> Welcome to our website!</h3>
                <p> You can search for books you want to buy, but we don't provide any transaction services. </p>
                <p> Therefore, in order to buy a book, you need to contact the seller directly by email.</p>    
            </div>
        </div>
        <div class = "mid-panel">
            {% comment %} <div class = "quick-search">
                <input class = "search-in" type="search" name="quick search" placeholder = "Quick Search">
            </div> {% endcomment %}
            <div class = "tab-bar">
                <button class = "tab-btn active-tab" type="button" name="tradeboard" style="width:120px; height:30px;margin:5px;padding:5px">Trade Board</button>
                <button class = "tab-btn active-tab" type="button" name="bookmark" style="width:150px; height:30px;margin:5px;padding:5px">My Bookmarks</button>
                <button class = "tab-btn active-tab" type="button" name="sell-list" style="width:150px; height:30px;margin:5px;padding:5px">My Selling List</button>
            </div>
            <div class = "mid-panel-scroll">
                
            </div>
        </div>

        <div class = "right-panel">
            <div class = "nav">
                {% if user.is_authenticated %}
                    <a  href="{% url 'profile' %}">
                        <button class = "tab-btn active-tab" type="button" name="profile" style="width:70px; height:30px;margin:5px;padding:5px">Profile</button>
                    </a>
                    <a  href="{% url 'logout' %}">
                        <button class = "tab-btn active-tab" type="button" name="logout" style="width:70px; height:30px;margin:5px;padding:5px">Logout</button>
                    </a>
                    <a  href="{% url 'book_new' %}"> 
                        <button class = "tab-btn active-tab" type="button" name="sell" style="width:100px; height:30px;margin:5px;padding:5px">Sell A Book</button>
                    </a> 
                {% else %}
                    <a class="nav-item nav-link" href="{% url 'login' %}">Login</a>
                    <a class="nav-item nav-link" href="{% url 'register' %}">Register</a>
                {% endif %}
            </div>

            <form class= "search-filters" method="POST" name="filter-books"> 
                <h1 style="color: #0066ff;">
                    Search:
                </h1>    
                <div class="hint">
                    <p class = "hint-text" style="color: #0066ff;">You can narrow down your search result by applying the following filters</p>
                    <div class="vertical-accent-bar"></div>
                </div>
                {% csrf_token %}
                {{ search_form.non_field_errors }}
                <div class = "search title-field">
                    <label class = "filter-label f-title" for="{{ form.title.id_for_label }}">Title</label>
                    {{ search_form.title }}
                    <div class="error">
                        {{ search_form.title.errors }}
                    </div>
                </div>
                <div class = "arrange-as-row">
                    <div class="search author-field">
                        <label class = "filter-label"  for="{{ form.author.id_for_label }}">Author</label>
                        {{ search_form.author}}
                        <div class="error">
                            {{ search_form.author.errors }}
                        </div>
                    </div>
                    <div class="search ISBN-field">
                        <label class = "filter-label" for="{{ form.ISBN.id_for_label }}">ISBN</label>
                        {{ search_form.ISBN }}
                        <div class="error">
                            {{ search_form.ISBN.errors }}
                        </div>
                    </div>
                </div>
                <div class = "arrange-as-row">
                    <div class="search edition-field">
                        <label class = "filter-label" for="{{ form.edition.id_for_label }}">Edition</label>
                        {{ search_form.edition }}
                        <div class="error">
                            {{ search_form.edition.errors }}
                        </div>
                    </div>
                    <div class="search price-field">
                        <label class = "filter-label" for="{{ form.price.id_for_label }}">Max Price</label>
                        {{ search_form.price }}
                        <div class="error">
                            {{ search_form.price.errors }}
                        </div>
                    </div>
                </div>
                <div class = "arrange-as-row">
                    <div class = "search posted-since-field">
                        <label class = "filter-label" for="{{ form.posted_since.id_for_label }}">Posted Since</label>
                        <div class = "cont-date-select" >{{ search_form.posted_since }} </div>
                        <div class="error">
                            {{ search_form.posted_since.errors }}
                        </div>
                    </div>
                    <div class = "search book-type-field">
                        <label class = "filter-label" for="{{ form.post_type.id_for_label }}">Book Type</label>
                        {{ search_form.post_type }}
                        <div class="error">
                            {{ search_form.post_type.errors }}
                        </div>
                    </div>
                </div>
                <div class= "arrange-as-row flex-justify-start">
                    <button class= "clear-btn" type = "button" value = "clear" name="clear" onclick="clearForm()">
                        <svg transform="translate(-3 3)" width="11" height="11" viewBox="0 0 19.998 25.383">
                            <g transform="translate(-1 0)" fill="white" stroke="none">
                                <path d="M16.043,11.667L22.609,5.1c0.963-0.963,0.963-2.539,0-3.502l-0.875-0.875c-0.963-0.964-2.539-0.964-3.502,0L11.666,7.29  L5.099,0.723c-0.962-0.963-2.538-0.963-3.501,0L0.722,1.598c-0.962,0.963-0.962,2.539,0,3.502l6.566,6.566l-6.566,6.567  c-0.962,0.963-0.962,2.539,0,3.501l0.876,0.875c0.963,0.963,2.539,0.963,3.501,0l6.567-6.565l6.566,6.565  c0.963,0.963,2.539,0.963,3.502,0l0.875-0.875c0.963-0.963,0.963-2.539,0-3.501L16.043,11.667z"/>
                            </g>
                        </svg>
                        Clear 
                    </button>
                    <button class= "search-btn" type = "button" name="filter" onclick="submitForm()"> Apply Filter </button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="text/javascript">
        tabBtns = document.querySelectorAll(".tab-btn")
        for(var i=0; i<tabBtns.length;i++){
            tabBtns[i].onclick=function(){
                console.log(tabBtns);
                for(var i=0; i<tabBtns.length;i++){
                    tabBtns[i].classList.remove("active-tab")
                }
                this.classList.add("active-tab");
                if (this.name == "tradeboard"){
                    loadTradeboard()
                }
                else if(this.name == "bookmark"){
                    loadBookmarks()
                }
                else{
                    loadSellList()
                }
            }
        }
        function loadTradeboard(){
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    "action":"loadTradeboard"
                },
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp);
                    activate()
                },
                error: function(data) {
                    console.log("reponse not recieved - submit form error")
                }
            });
        }

        function loadBookmarks(){
            console.log("load bookmarks called")
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    "action":"loadBookmarks"
                },
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp);
                    activate()
                },
                error: function(data) {
                    console.log("reponse not recieved - submit form error")
                }
            });
        }

        function loadSellList(){
            console.log("load bookmarks called")
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    "action":"loadSellList"
                },
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp);
                    activate()
                },
                error: function(data) {
                    console.log("reponse not recieved - submit form error")
                }
            });
        }

        function activateExpand() {
            console.log("[activateExpand] function called")
            expands = document.querySelectorAll("svg.expand")
            for(var i=0; i<expands.length;i++){
                expands[i].onclick=function(){
                    console.log(this.id.concat(" clicked"))
                    max = document.getElementById("post-max-"+ this.id.substring(4)); 
                    max.classList.toggle("show");
                    this.classList.toggle("expanded");
                }
            }
        }

        function activateBookmark(){
            console.log("[activateBookmark] function called")
            bookmarks=document.querySelectorAll("svg.bookmark");
            for(var i=0; i<bookmarks.length;i++){
                bookmarks[i].onclick=function(){
                    console.log(this.id.concat(" clicked"));
                    $.ajax({
                        url: "{% url 'tradeboard-home' %}",
                        headers: {'X-CSRFToken': '{{ csrf_token }}'},
                        method: "POST",
                        data: {
                            "action": "bookmark",
                            "pk": this.id.substring(4)
                        },
                        success: function(resp){
                            console.log(resp);
                            bkm = document.getElementById(('bkm-'+resp['pk']))
                            if (resp.bookmarked) {
                                bkm.classList.toggle("bookmarked", true);
                            }
                            else{
                                bkm.classList.toggle("bookmarked", false);
                            }
                        }, error: function(error){
                            console.log("error");
                            console.log(error);
                        }
                    })
                }
            }
        }

        function activate(){
            activateBookmark()
            activateExpand()
        }
        function submitForm(){
            tabBtns = document.querySelectorAll(".tab-btn")
            for(var i=0; i<tabBtns.length;i++){
                if (tabBtns[i].name == "tradeboard"){
                    tabBtns[i].classList.toggle('active-tab', true)
                }
                else {
                    tabBtns[i].classList.remove("active-tab")
                }
            }
            var frm = $('.search-filters');
            console.log(frm.serialize())
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: frm.serialize(),
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp);
                    activate()
                },
                error: function(data) {
                    console.log("reponse not recieved - submit form error")
                }
            });
        }

        function clearForm(){
            tabBtns = document.querySelectorAll(".tab-btn")
            for(var i=0; i<tabBtns.length;i++){
                if (tabBtns[i].name == "tradeboard"){
                    tabBtns[i].classList.toggle('active-tab', true)
                }
                else {
                    tabBtns[i].classList.remove("active-tab")
                }
            }

            var frm = $('.search-filters');
            frm[0].reset()

            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    'action':'clear'
                },
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp);
                    activate()
                },
                error: function(data) {
                    console.log("reponse not recieved - submit form error")
                }
            });
        }
        function initialize() {
            console.log("initialize"),
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    "action": "initialize"
                },
                success: function(resp){
                    console.log("Initialize success, response recieved from server");
                    $('.mid-panel-scroll').html(resp);
                    activate()
                }, error: function(error){
                    console.log("error");
                    console.log(error);
                }
            })
        }
        initialize();
    </script>

{% endblock %}