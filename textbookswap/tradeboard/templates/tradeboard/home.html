{% extends 'tradeboard/base.html' %}
{% load static %}

{% block content %}

    <link rel="stylesheet" type="text/css" href="{% static 'tradeboard/tb_main.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <style>
        .instruction {
            height: 250px;
            width: 200px;
          background-color: white;
          color: #0066ff;
          margin: 20px;
          padding: 20px;
        } 
        </style>
    <div class = "popup">

    </div>

    <div class = "panels">
        <div class = "left-panel">
            <div class = "profile-section">
                <img class= "profile-pic" src = "{{user.profile.image.url}}"/>
                <div class = "profile-info">
                    <h2 class = "fl-users-name">{{user.first_name}} {{user.last_name}}</h2>
                </div>
                <hr/>
            </div>
            <div class = "instruction">
                <h3> Welcome to our website!</h3>
                <p> You can search for books you want to buy, but we don't provide any transaction services. </p>
                <p> Therefore, in order to buy a book, you need to contact the seller directly by email.</p>    
            </div>
        </div>
        <div class = "mid-panel">
            {% comment %} <div class = "quick-search">
                <input class = "search-in" type="search" name="quick search" placeholder = "Quick Search">
            </div> {% endcomment %}
            <div class = "tab-bar">
                <button class = "tab-btn active-tab" type="button" name="tradeboard">Trade Board</button>
                <button class = "tab-btn" type="button" name="bookmark">My Bookmarks</button>
                <button class = "tab-btn" type="button" name="sell-list">My Selling List</button>
            </div>
            <div class = "mid-panel-scroll">
                
            </div>
        </div>

        <div class = "right-panel">
            <div class = "nav">
                {% if user.is_authenticated %}
                    <a  href="{% url 'profile' %}">
                        <button class = "tab-btn active-tab" type="button" name="profile" style="width:70px; height:30px;margin:5px;padding:5px">Profile</button>
                    </a>
                    <a  href="{% url 'logout' %}">
                        <button class = "tab-btn active-tab" type="button" name="logout" style="width:70px; height:30px;margin:5px;padding:5px">Logout</button>
                    </a>
                    <a  href="{% url 'book_new' %}"> 
                        <button class = "tab-btn active-tab" type="button" name="sell" style="width:100px; height:30px;margin:5px;padding:5px">Sell A Book</button>
                    </a> 
                {% else %}
                    <a class="nav-item nav-link" href="{% url 'login' %}">Login</a>
                    <a class="nav-item nav-link" href="{% url 'register' %}">Register</a>
                {% endif %}
            </div>

            <div class="form-div">
                {% include "tradeboard/searchForm.html" %}
            </div>
        </div>
    </div>
    
    <script type="text/javascript">
        tabBtns = document.querySelectorAll(".tab-btn")
        for(var i=0; i<tabBtns.length;i++){
            tabBtns[i].onclick=function(){
                console.log(tabBtns);
                for(var i=0; i<tabBtns.length;i++){
                    tabBtns[i].classList.remove("active-tab")
                }
                this.classList.add("active-tab");
                if (this.name == "tradeboard"){
                    loadTradeboard()
                }
                else if(this.name == "bookmark"){
                    loadBookmarks()
                }
                else{
                    loadSellList()
                }
            }
        }

        function loadTradeboard(){
            var frm = $('.search-filters');
            console.log(frm.serialize())
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: frm.serialize(),
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp.searchResults);
                    $('.form-div').html(resp.form);
                    activate()
                },
                error: function(resp) {
                    console.log("submit form error")
                    $('.form-div').html(resp.responseText);
                }
            });
        }

        function loadBookmarks(){
            console.log("load bookmarks called")
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    "action":"loadBookmarks"
                },
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp);
                    activate()
                },
                error: function(data) {
                    console.log("reponse not recieved - submit form error")
                }
            });
        }

        function loadSellList(){
            console.log("load bookmarks called")
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    "action":"loadSellList"
                },
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp);
                    activate()
                },
                error: function(data) {
                    console.log("form error detected")

                }
            });
        }

        function activateExpand() {
            console.log("[activateExpand] function called")
            expands = document.querySelectorAll("svg.expand")
            for(var i=0; i<expands.length;i++){
                expands[i].onclick=function(){
                    console.log(this.id.concat(" clicked"))
                    max = document.getElementById("post-max-"+ this.id.substring(4)); 
                    max.classList.toggle("show");
                    this.classList.toggle("expanded");
                }
            }
            texpands = document.querySelectorAll(".book-title")
            for(var i=0; i<texpands.length;i++){
                texpands[i].onclick=function(){
                    console.log(this.id.concat(" clicked"))
                    max = document.getElementById("post-max-"+ this.id.substring(6)); 
                    max.classList.toggle("show");
                    exp = document.getElementById("exp-"+ this.id.substring(6));
                    exp.classList.toggle("expanded");
                }
            }
        }

        function activateBookmark(){
            console.log("[activateBookmark] function called")
            bookmarks=document.querySelectorAll("svg.bookmark");
            for(var i=0; i<bookmarks.length;i++){
                bookmarks[i].onclick=function(){
                    console.log(this.id.concat(" clicked"));
                    $.ajax({
                        url: "{% url 'tradeboard-home' %}",
                        headers: {'X-CSRFToken': '{{ csrf_token }}'},
                        method: "POST",
                        data: {
                            "action": "bookmark",
                            "pk": this.id.substring(4)
                        },
                        success: function(resp){
                            console.log(resp);
                            bkm = document.getElementById(('bkm-'+resp['pk']))
                            if (resp.bookmarked) {
                                bkm.classList.toggle("bookmarked", true);
                            }
                            else{
                                bkm.classList.toggle("bookmarked", false);
                            }
                        }, error: function(error){
                            console.log("error");
                            console.log(error);
                        }
                    })
                }
            }
        }

        function activate(){
            activateBookmark()
            activateExpand()
        }

        function confirmPopUp(action,post,confirmed=false){
            console.log("sonfirmPopUp clicked")
            console.log("action =", action)
            console.log("post id =", post)
            if(confirmed){
                $.ajax({
                    url: "{% url 'tradeboard-home' %}",
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    method: "POST",
                    data: {
                        'action':action,
                        'post':post
                    },
                    success: function (resp) {
                        console.log(resp)
                        loadSellList()
                        removePopUp()
                    },
                    error: function(data) {

                    }
                });
            }
            else{
                pop = document.querySelectorAll(".popup")
                html = "<div class='pop-box'><p class='prompt'> Are you sure?</p><div class='arrange-as-row'><button class='yes' onclick='confirmPopUp("+'"'+action+'"'+","+post+","+true+")'>Confirm</button><button class='no' onclick='removePopUp()'>Cancel</button></div></div>"
                pop[0].innerHTML=html;
                pop[0].classList.toggle("visible")
                panels = document.querySelectorAll(".panels")
                panels[0].classList.toggle("blurred")
            }
            
        }

        function viewMorePopUp(action,post,confirmed=false){
            console.log("xiewMorePopUp clicked")
            console.log("action =", action)
            console.log("post id =", post)
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    'action':action,
                    'confirmed':confirmed
                },
                success: function (resp) {

                },
                error: function(data) {

                }
            });
        }

        function removePopUp(){
            pop = document.querySelectorAll(".popup")
            pop[0].innerHTML=""
            pop[0].classList.toggle("visible")
            panels = document.querySelectorAll(".panels")
            panels[0].classList.toggle("blurred")
        }

        function formPopUp(action,post){
            console.log("formPopUp clicked")
            console.log("action =", action)
            console.log("post id =", post)
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    'action':action
                },
                success: function (resp) {

                },
                error: function(data) {

                }
            });
        }

        function submitForm(){
            tabBtns = document.querySelectorAll(".tab-btn")
            for(var i=0; i<tabBtns.length;i++){
                if (tabBtns[i].name == "tradeboard"){
                    tabBtns[i].classList.toggle('active-tab', true)
                }
                else {
                    tabBtns[i].classList.remove("active-tab")
                }
            }
            var frm = $('.search-filters');
            console.log(frm.serialize())
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: frm.serialize(),
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp.searchResults);
                    $('.form-div').html(resp.form);
                    activate()
                },
                error: function(resp) {
                    console.log("submit form error")
                    $('.form-div').html(resp.responseText);
                }
            });
        }

        function clearForm(){
            tabBtns = document.querySelectorAll(".tab-btn")
            for(var i=0; i<tabBtns.length;i++){
                if (tabBtns[i].name == "tradeboard"){
                    tabBtns[i].classList.toggle('active-tab', true)
                }
                else {
                    tabBtns[i].classList.remove("active-tab")
                }
            }

            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    'action':'clear'
                },
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp.searchResults);
                    $('.form-div').html(resp.form);
                    activate()
                },
                error: function(data) {
                    console.log("reponse not recieved - submit form error")
                }
            });
        }

        function initialize() {
            console.log("initialize"),
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    "action": "initialize"
                },
                success: function(resp){
                    console.log("Initialize success, response recieved from server");
                    $('.mid-panel-scroll').html(resp);
                    activate()
                }, error: function(error){
                    console.log("error");
                    console.log(error);
                }
            })
        }
        initialize();
    </script>

{% endblock %}