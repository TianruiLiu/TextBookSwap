{% extends 'tradeboard/base.html' %}
{% load static %}

{% block content %}

    <style>
        .instruction {
            height: 250px;
            width: 200px;
          background-color: white;
          color: #0066ff;
          margin: 20px;
          padding: 20px;
        } 
        </style>
    <div class = "popup">

    </div>

    <div class = "panels">
        <div class = "left-panel">
            <div class = "profile-section">
                <img class= "profile-pic" src = "{{user.profile.image.url}}"/>
                <div class = "profile-info">
                    <h2 class = "fl-users-name">{{user.first_name}} {{user.last_name}}</h2>
                </div>
                <hr/>
            </div>
            <div class = "instruction">
                <h3> Welcome to our website!</h3>
                <p> You can search for books you want to buy, but we don't provide any transaction services. </p>
                <p> Therefore, in order to buy a book, you need to contact the seller directly by email.</p>    
            </div>
        </div>
        <div class = "mid-panel">
            <div class = "tab-bar">
                <div class= "arrange-as-row tab-row">
                    <button class = "tab-btn active-tab" type="button" name="tradeboard">Trade Board</button>
                    <button class = "tab-btn" type="button" name="bookmark">My Bookmarks</button>
                    <button class = "tab-btn" type="button" name="sell-list">My Selling List </button>
                </div>
                <div class= "extra">
                    <hr class="tab-divider">
                    <div class= "arrange-as-row">
                        <p class = "question">Do you have a book that you'd like to sell?</p>
                        <button class = "sell-btn" onclick="newPostForm()">Sell A Book</button>
                    </div>
                </div>
            </div>
            <div class = "mid-panel-scroll">
                
            </div>
        </div>

        <div class = "right-panel">
            <div class = "nav">
                {% if user.is_authenticated %}
                    <a  href="{% url 'profile' %}">
                        <button class = "nav-btn" type="button" name="profile" >Profile</button>
                    </a>
                    <a  href="{% url 'logout' %}">
                        <button class = "nav-btn" type="button" name="logout" >Logout</button>
                    </a>
                    <button class = "nav-btn" type="button" name="sell" onclick="newPostForm()">Sell A Book</button>
                {% else %}
                    <a class="nav-item nav-link" href="{% url 'login' %}">Login</a>
                    <a class="nav-item nav-link" href="{% url 'register' %}">Register</a>
                {% endif %}
            </div>

            <div class="form-div">
                {% include "tradeboard/searchForm.html" %}
            </div>
        </div>
    </div>
    
    <script type="text/javascript">
        tabBtns = document.querySelectorAll(".tab-btn")
        for(var i=0; i<tabBtns.length;i++){
            tabBtns[i].onclick=function(){
                if (this.name == "tradeboard"){
                    loadTradeboard()
                }
                else if(this.name == "bookmark"){
                    loadBookmarks()
                }
                else{
                    loadSellList()
                }
            }
        }

        function switchTab(tab){
            tabBtns = document.querySelectorAll(".tab-btn")
            for(var i=0; i<tabBtns.length;i++){
                if(tabBtns[i].name == tab){
                    tabBtns[i].classList.toggle("active-tab", true)
                }
                else {
                    tabBtns[i].classList.toggle("active-tab", false)
                }
                
            }
            tabBar= document.querySelectorAll(".tab-bar")
            if(tab == "sell-list"){
                console.log("sell-list-tab-yes")
                tabBar[0].classList.toggle("expanded", true)
            }
            else{
                console.log("sell-list-tab-no")
                tabBar[0].classList.toggle("expanded", false)
            }
        }

        function upload_img(input) {
            console.log("update-img-called")
            console.log(input.files[0])
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    $('#pre-img').attr('src', e.target.result);
                }

                reader.readAsDataURL(input.files[0]);
            }
        }

        function loadTradeboard(){
            var frm = $('.search-filters');
            console.log(frm.serialize())
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: frm.serialize(),
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp.searchResults);
                    $('.form-div').html(resp.form);
                    switchTab("tradeboard");
                    activate()
                },
                error: function(resp) {
                    console.log("submit form error")
                    $('.form-div').html(resp.responseText);
                }
            });
        }

        function loadBookmarks(){
            console.log("load bookmarks called")
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    "action":"loadBookmarks"
                },
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp);
                    switchTab("bookmark");
                    activate()
                },
                error: function(data) {
                    console.log("reponse not recieved - submit form error")
                }
            });
        }

        function loadSellList(){
            console.log("load bookmarks called")
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    "action":"loadSellList"
                },
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp);
                    switchTab("sell-list");
                    activate()
                },
                error: function(data) {
                    console.log("form error detected")

                }
            });
        }

        function activateExpand() {
            console.log("[activateExpand] function called")
            expands = document.querySelectorAll("svg.expand")
            for(var i=0; i<expands.length;i++){
                expands[i].onclick=function(){
                    console.log(this.id.concat(" clicked"))
                    max = document.getElementById("post-max-"+ this.id.substring(4)); 
                    max.classList.toggle("show");
                    this.classList.toggle("expanded");
                }
            }
            texpands = document.querySelectorAll(".book-title")
            for(var i=0; i<texpands.length;i++){
                texpands[i].onclick=function(){
                    console.log(this.id.concat(" clicked"))
                    max = document.getElementById("post-max-"+ this.id.substring(6)); 
                    max.classList.toggle("show");
                    exp = document.getElementById("exp-"+ this.id.substring(6));
                    exp.classList.toggle("expanded");
                }
            }
        }

        function activateBookmark(){
            console.log("[activateBookmark] function called")
            bookmarks=document.querySelectorAll("svg.bookmark");
            for(var i=0; i<bookmarks.length;i++){
                bookmarks[i].onclick=function(){
                    console.log(this.id.concat(" clicked"));
                    $.ajax({
                        url: "{% url 'tradeboard-home' %}",
                        headers: {'X-CSRFToken': '{{ csrf_token }}'},
                        method: "POST",
                        data: {
                            "action": "bookmark",
                            "pk": this.id.substring(4)
                        },
                        success: function(resp){
                            console.log(resp);
                            bkm = document.getElementById(('bkm-'+resp['pk']))
                            if (resp.bookmarked) {
                                bkm.classList.toggle("bookmarked", true);
                            }
                            else{
                                bkm.classList.toggle("bookmarked", false);
                            }
                        }, error: function(error){
                            console.log("error");
                            console.log(error);
                        }
                    })
                }
            }
        }

        function activate(){
            activateBookmark()
            activateExpand()
        }

        function confirmPopUp(action,post,confirmed=false){
            console.log("sonfirmPopUp clicked")
            console.log("action =", action)
            console.log("post id =", post)
            if(confirmed){
                $.ajax({
                    url: "{% url 'tradeboard-home' %}",
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    method: "POST",
                    data: {
                        'action':action,
                        'post':post
                    },
                    success: function (resp) {
                        console.log(resp)
                        loadSellList()
                        removePopUp()
                    },
                    error: function(data) {

                    }
                });
            }
            else{
                pop = document.querySelectorAll(".popup")
                html = "<div class='pop-box'><p class='prompt'> Are you sure?</p><div class='arrange-as-row'><button class='yes' onclick='confirmPopUp("+'"'+action+'"'+","+post+","+true+")'>Confirm</button><button class='no' onclick='removePopUp()'>Cancel</button></div></div>"
                pop[0].innerHTML=html;
                pop[0].classList.toggle("visible")
                panels = document.querySelectorAll(".panels")
                panels[0].classList.toggle("blurred")
            }
            
        }

        function viewMorePopUp(action,post,confirmed=false){
            console.log("xiewMorePopUp clicked")
            console.log("action =", action)
            console.log("post id =", post)
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    'action':action,
                    'confirmed':confirmed
                },
                success: function (resp) {

                },
                error: function(data) {

                }
            });
        }

        function removePopUp(){
            pop = document.querySelectorAll(".popup")
            pop[0].classList.toggle("remove",true)
            setTimeout(() => { 
                pop = document.querySelectorAll(".popup")
                pop[0].innerHTML=""
                pop[0].classList.toggle("visible", false)
                pop[0].classList.toggle("remove", false)
                panels = document.querySelectorAll(".panels")
                panels[0].classList.toggle("blurred", false)
             }, 150);
        }

        function submitForm(){
            switchTab("tradeboard");
            var frm = $('.search-filters');
            frm = frm.serialize()
            console.log(frm)
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: frm,
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.mid-panel-scroll').html(resp.searchResults);
                    $('.form-div').html(resp.form);
                    activate()
                },
                error: function(resp) {
                    console.log("submit form error")
                    $('.form-div').html(resp.responseText);
                }
            });
        }

        function newPostForm(confirmed=false){
            if(confirmed){
                options = {
                    url: "{% url 'tradeboard-home' %}",
                    type: 'POST',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    success: function(resp) {
                        console.log(resp)
                        loadSellList()
                        removePopUp()
                    }
                };

                $('#new-post-form').ajaxSubmit(options);
                console.log("confirmed new post function called")
            }
            else{
                $.ajax({
                    url: "{% url 'tradeboard-home' %}",
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    method: "POST",
                    data: {
                        'action':'get-new-post-form'
                    },
                    success: function (resp) {
                        pop = document.querySelectorAll(".popup")
                        pop[0].innerHTML=resp;
                        pop[0].classList.toggle("visible")
                        panels = document.querySelectorAll(".panels")
                        panels[0].classList.toggle("blurred")
                    },
                    error: function(data) {

                    }
                });
            }
        }

        function clearForm(){
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    'action':'clear'
                },
                success: function (resp) {
                    console.log("reponse recieved")
                    $('.form-div').html(resp);
                    loadTradeboard()
                    activate()
                },
                error: function(data) {
                    console.log("reponse not recieved - submit form error")
                }
            });
        }

        function initialize() {
            console.log("initialize"),
            $.ajax({
                url: "{% url 'tradeboard-home' %}",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                method: "POST",
                data: {
                    "action": "initialize"
                },
                success: function(resp){
                    console.log("Initialize success, response recieved from server");
                    $('.mid-panel-scroll').html(resp);
                    activate()
                }, error: function(error){
                    console.log("error");
                    console.log(error);
                }
            })
        }
        initialize();
    </script>

{% endblock %}